DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 1

0000                         1  ; STOPWATCH FORMAT HH2_HH1:MM2_MM1:SS2_SS1
0000                         2  
008C                         3  TR0 BIT TCON.4
008D                         4  TF0 BIT TCON.5
0000                         5  ;-------------
0093                         6  R BIT P1.3
0000                         7  ;-------------
0080                         8  LDATA EQU P0
0000                         9  ;------------
0082                        10  EN EQU P0.2
0080                        11  RS EQU P0.0
0081                        12  WR EQU P0.1
0000                        13  ;------------
0030                        14  SS1 EQU 30H
0031                        15  SS2	EQU 31H
0032                        16  MM1 EQU	32H
0033                        17  MM2 EQU 33H
0034                        18  HH1	EQU	34H
0035                        19  HH2	EQU	35H
0000                        20  
0000                        21  		ORG 00H 
0000  02 03 00              22  	LJMP INIT
0003                        23  
0003                        24  		ORG 003H ; EX0 INT VECTOR ADDRESS
0003  02 00 0E              25  	LJMP EX0ISR
0006                        26  
0013                        27  		ORG 013H ; EX1 INT VECTOR ADDRESS
0013  02 00 11              28  	LJMP EX1ISR
0016                        29  
000B                        30  		ORG 00BH ; TESTING QALLAF
000B  02 00 14              31  	LJMP T0ISR
000E                        32  ;--------INTERRUPT ROUTINES---
000E                        33  EX0ISR:
000E  12 04 1E              34  	LCALL PROMPT
0011                        35  
0011                        36  EX1ISR:
0011  12 88 88              37  	 LCALL RESTART_LCD
  ** ERROR ** - 5 - Undefined symbol
0014                        38  
0014                        39  T0ISR:
0014  12 03 69              40  	LCALL IntDELAY
0017                        41  
0017                        42  ;------------------------------
0300                        43  		ORG 300H
0300                        44  INIT:	
0300  75 89 01              45  	MOV TMOD,#000000001B
0303                        46  	
0303  75 30 00              47  	MOV SS1,#0    ; SS
0306  75 30 00              48  	MOV SS1,#0    ; SS
0309  75 32 00              49  	MOV MM1,#0    ; MM
030C  75 33 00              50  	MOV MM2,#0    ; MM
030F  75 34 00              51  	MOV HH1,#0    ; HH
0312  75 35 00              52  	MOV HH2,#0    ; HH
0315                        53  
0315                        54  AGAIN:
0315                        55  	;--------------SEND HH---------
0315  71 CC                 56  	ACALL LCD
0317  E5 35                 57  	MOV A,HH2 ; MOVE THE HH SECOND
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 2

0319  24 30                 58  	ADD A,#30H	;HEXIFY
031B  91 41                 59  	ACALL WCHR 
031D  91 5E                 60  	ACALL LDELAY ; 4.1 msec required for this command
031F                        61  	;---HH1
031F  E5 34                 62  	MOV A,HH1 ; MOVE THE HH FIRST
0321  24 30                 63  	ADD A,#30H
0323  91 41                 64  	ACALL WCHR 
0325  91 5E                 65  	ACALL LDELAY ; 4.1 msec required for this command
0327                        66  	
0327  74 3A                 67  	MOV A,#':' ; PUT A COLOR 
0329  91 41                 68  	ACALL WCHR 
032B  91 5E                 69  	ACALL LDELAY ; 4.1 msec required for this command
032D                        70  	;-------------- NOW SEND MM---------------
032D  E5 33                 71  	MOV A,MM2 ; MOVE THE MM SECOND
032F  24 30                 72  	ADD A,#30H
0331  91 41                 73  	ACALL WCHR 
0333  91 5E                 74  	ACALL LDELAY ; 4.1 msec required for this command
0335                        75  	
0335  E5 32                 76  	MOV A,MM1 ; MOVE THE MM SECOND
0337  24 30                 77  	ADD A,#30H
0339  91 41                 78  	ACALL WCHR 
033B  91 5E                 79  	ACALL LDELAY ; 4.1 msec required for this command
033D                        80  	
033D  74 3A                 81  	MOV A,#':' ; MOVE THE : 
033F  91 41                 82  	ACALL WCHR 
0341  91 5E                 83  	ACALL LDELAY ; 4.1 msec required for this command
0343                        84  	;------------------ NOW SEND SS --------------------------------
0343                        85  	
0343  E5 31                 86  	MOV A,SS2 ; MOVE THE SS FIRST
0345  24 30                 87  	ADD A,#30H
0347  91 41                 88  	ACALL WCHR 
0349  91 5E                 89  	ACALL LDELAY ; 4.1 msec required for this command
034B                        90  	
034B  E5 30                 91  	MOV A,SS1 ; MOVE THE SS FIRST
034D  24 30                 92  	ADD A,#30H
034F  91 41                 93  	ACALL WCHR 
0351  91 5E                 94  	ACALL LDELAY ; 4.1 msec required for this command
0353                        95  	
0353                        96  	;------ RESUME
0353                        97  
0353  02 03 15              98  	LJMP AGAIN
0356                        99  
0356                       100  RESETT:
0356  75 34 00             101  	MOV HH1,#0
0359  75 35 00             102  	MOV HH2,#0
035C  75 32 00             103  	MOV MM1,#0
035F  75 33 00             104  	MOV MM2,#0
0362  75 30 00             105  	MOV SS1,#0
0365  75 31 00             106  	MOV SS2,#0
0368  22                   107  	RET
0369                       108  
0369                       109  	
0369                       110  ;---START OF SUB PROCESSES
0369                       111  IntDELAY:
0369  DE 60                112  	DJNZ R6,OUTT
036B                       113  
036B  A2 93                114  	MOV C,R
036D  B3                   115  	CPL C
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 3

036E  92 93                116  	MOV R,C
0370                       117  
0370  7E 64                118  	MOV R6,#100
0372                       119  	
0372  75 8C B7             120  	MOV TH0,#0B7H
0375  75 8A EE             121  	MOV TL0,#0EEH	
0378                       122  ;-------------- HANDLE THE HH2HH1:MM2MM1:SS2SS1
0378                       123  	
0378  E5 30                124  	MOV A,SS1
037A  B4 09 33             125  	CJNE A,#9,INC_SS1
037D  75 30 00             126  	MOV SS1,#0			;MAKE ZER0
0380                       127  	
0380  E5 31                128  	MOV A,SS2
0382  B4 05 30             129  	CJNE A,#5,INC_SS2
0385  75 31 00             130  	MOV SS2,#0			;MAKE ZERO
0388                       131  	
0388  E5 32                132  	MOV A,MM1
038A  B4 09 2D             133  	CJNE A,#9,INC_MM1
038D  75 32 00             134  	MOV MM1,#0			;MAKE ZERO
0390                       135  	
0390  E5 33                136  	MOV A,MM2
0392  B4 05 2A             137  	CJNE A,#5,INC_MM2
0395  75 33 00             138  	MOV MM2,#0
0398                       139  	
0398  E5 34                140  	MOV A,HH1
039A  B4 03 02             141  	CJNE A,#3,IsH1equal9
039D  80 06                142  	SJMP IsH2equal2
039F                       143  	
039F                       144  	
039F                       145  IsH1equal9:
039F  B4 09 22             146  	CJNE A,#9,INC_HH1
03A2  75 34 00             147  	MOV HH1,#0
03A5                       148  IsH2equal2:
03A5  E5 35                149  	MOV A,HH2
03A7  B4 02 1F             150  	CJNE A,#2,INC_HH2
03AA  12 03 56             151  	LCALL RESETT
03AD  02 03 CB             152  	LJMP OUTT
03B0                       153  	
03B0                       154  INC_SS1:
03B0  05 30                155  	INC SS1
03B2  02 03 CB             156  	LJMP OUTT
03B5                       157  INC_SS2:
03B5  05 31                158  	INC SS2
03B7  02 03 CB             159  	LJMP OUTT
03BA                       160  INC_MM1:
03BA  05 32                161  	INC MM1
03BC  02 03 CB             162  	LJMP OUTT
03BF                       163  INC_MM2:
03BF  05 33                164  	INC MM2
03C1  02 03 CB             165  	LJMP OUTT
03C4                       166  INC_HH1:
03C4  05 34                167  	INC HH1
03C6  02 03 CB             168  	LJMP OUTT
03C9                       169  INC_HH2:
03C9  05 35                170  	INC HH2
03CB                       171  	
03CB                       172  
03CB                       173  	
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 4

03CB                       174  	
03CB                       175  OUTT:
03CB  32                   176  	RETI	
03CC                       177  
03CC                       178  ;------------LCD
03CC                       179  START:
03CC                       180  LCD:		
03CC  71 D8                181  	ACALL INLCD ; Initialize LCD
03CE  74 08                182  	MOV A,#1000B ; Move cursor to 1st line – send high nibble
03D0  91 2E                183  	ACALL CMD
03D2  74 00                184  	MOV A,#0000B ; send low nibble
03D4  91 2E                185  	ACALL CMD
03D6  91 5E                186  	ACALL LDELAY ; 4.1 msec required for this command
03D8                       187  
03D8                       188  ;-- LCD Initialization Procedure starts here -----
03D8                       189  INLCD:
03D8  7F 14                190  	MOV R7,#20
03DA                       191  WAIT:
03DA  91 5E                192  	ACALL LDELAY ; Step 1
03DC  DF FC                193  	DJNZ R7,WAIT
03DE  75 80 07             194  	MOV P0,#00000111B ; Initialise 3 control signals=1
03E1                       195  	
03E1  74 03                196  	MOV A,#0011B ; Step 2
03E3  91 2E                197  	ACALL CMD
03E5  91 5E                198  	ACALL LDELAY ; Step 3
03E7  74 03                199  	MOV A,#0011B ; Step 4
03E9  91 2E                200  	ACALL CMD
03EB  74 03                201  	MOV A,#0011B ; Step 5
03ED  91 2E                202  	ACALL CMD
03EF  74 02                203  	MOV A,#0010B ; Step 6
03F1  91 2E                204  	ACALL CMD
03F3  74 02                205  	MOV A,#0010B ; Step 7 – send high nibble <FUNCTION SET?>
03F5  91 2E                206  	ACALL CMD
03F7  74 08                207  	MOV A,#1000B ; send low nibble
03F9  91 2E                208  	ACALL CMD
03FB  74 00                209  	MOV A,#0000B ; Step 8 – Turn off display – send high nibble
03FD  91 2E                210  	ACALL CMD
03FF  74 08                211  	MOV A,#1000B ; send low nibble
0401  91 2E                212  	ACALL CMD
0403  74 00                213  	MOV A,#0 ; Step 9 - Clear Display – send high nibble
0405  91 2E                214  	ACALL CMD
0407  74 01                215  	MOV A,#0001B ; send low nibble
0409  91 2E                216  	ACALL CMD
040B  91 5E                217  	ACALL LDELAY ; 4.1 msec required for this command
040D  74 00                218  	MOV A,#0000B ; Step 10 - Set cursor Move RIGHT - send high nibble
040F  91 2E                219  	ACALL CMD
0411  74 06                220  	MOV A,#0110B ; send low nibble
0413  91 2E                221  	ACALL CMD
0415  74 00                222  	MOV A,#0000B ; Step 11 – send high nibble
0417  91 2E                223  	ACALL CMD ; Turn ON Display, Cursor ON, Blink Cursor
0419  74 0F                224  	MOV A,#1111B ; send low nibble
041B  91 2E                225  	ACALL CMD
041D  22                   226  	RET
041E                       227  ;--- End of LCD initialization -----
041E                       228  ;----Routines:
041E                       229  PROMPT:
041E  91 2C                230  	ACALL LINE2		; GO TO LINE 2
0420  90 04 6F             231  	MOV DPTR,#PROMPT_MSG ; POINT TO MSG
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 5

0423  91 33                232  	ACALL WSTR				; WRITE STRING TO LCD
0425  91 5E                233  	ACALL LDELAY
0427  91 2A                234  	ACALL LINE1				; GO BACK TO LINE1
0429  22                   235  	RET
042A                       236  
042A                       237  ;---- Subroutines to write commands in A to the LCD -------
042A                       238  LINE1:
042A  74 00                239  	MOV A,#0
042C                       240  LINE2:
042C  74 C0                241  	MOV A,#11000000B	; 40 HEX = LINE 2
042E                       242  CMD:
042E  C2 80                243  	CLR RS 		; RS = 0 command write
0430  91 4D                244  	ACALL COMMON
0432  22                   245  	RET
0433                       246  ;---- Subroutine to write A STRING character by character -------
0433                       247  WSTR:
0433  C0 E0                248  	PUSH ACC 
0435                       249  CONT1: 
0435  E4                   250  	CLR A
0436  93                   251  	MOVC A,@A+DPTR
0437  60 05                252  	JZ EXIT1
0439  91 41                253  	ACALL WCHR
043B  A3                   254  	INC DPTR
043C  81 35                255  	AJMP CONT1
043E                       256  EXIT1:
043E  D0 E0                257  	POP ACC
0440  22                   258  	RET
0441                       259  	;---- Subroutine to write character in A to the LCD -------
0441                       260  WCHR:
0441  D2 80                261  	SETB RS ; RS = 1 data write
0443  F5 F0                262  	MOV B,A
0445  C4                   263  	SWAP A ; Move higher nibble to lower nibble
0446  91 4D                264  	ACALL COMMON ; write operation
0448  E5 F0                265  	MOV A,B
044A  91 4D                266  	ACALL COMMON
044C  22                   267  	RET
044D                       268  ;----- Common operation for CHAR write and COMMAND write
044D                       269  COMMON:
044D  C2 81                270  	CLR WR
044F  C4                   271  	SWAP A ; Move Lower nibble to higher nibble
0450  54 F0                272  	ANL A,#11110000B
0452  53 80 07             273  	ANL P0,#00000111B
0455  42 80                274  	ORL P0,A
0457  D2 82                275  	SETB EN
0459  C2 82                276  	CLR EN
045B  91 5E                277  	ACALL LDELAY
045D  22                   278  	RET
045E                       279  ;---- Subroutine to write A STRING character by character -------
045E                       280  
045E                       281  ;------------ ˜ 5.4 msec DELAY -------------------------------------------
045E                       282  LDELAY:
045E  C0 00                283  	PUSH 0
0460  C0 01                284  	PUSH 1 ; save register1.
0462  79 14                285  	MOV R1,#20
0464                       286  CON4: 
0464  78 FA                287  	MOV R0,#250
0466  D8 FE                288  	DJNZ R0,$
0468  D9 FA                289  	DJNZ R1,CON4
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 6

046A  D0 01                290  	POP 1
046C  D0 00                291  	POP 0
046E  22                   292  	RET
046F                       293  
046F  50 6C 65 61 73 65 +  294  PROMPT_MSG: STRZ "Please enter new time"
0485                       295  END

 1 error(s) occurred in this assembly.
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 7

SYMBOL TABLE:

AGAIN   -0315   CMD     -042E   COMMON  -044D   CON4    -0464   CONT1   -0435
EN      -0082   END     -0485   EX0ISR  -000E   EX1ISR  -0011   EXIT1   -043E
HH1     -0034   HH2     -0035   INC_HH1 -03C4   INC_HH2 -03C9   INC_MM1 -03BA
INC_MM2 -03BF   INC_SS1 -03B0   INC_SS2 -03B5   INIT    -0300   INLCD   -03D8
INTDELAY-0369   ISH1EQUAL9              -039F   ISH2EQUAL2              -03A5
LCD     -03CC   LDATA   -0080   LDELAY  -045E   LINE1   -042A   LINE2   -042C
MM1     -0032   MM2     -0033   OUTT    -03CB   PROMPT  -041E   PROMPT_MSG              -046F
R       -0093   RESETT  -0356   RS      -0080   SS1     -0030   SS2     -0031
START   -03CC   T0ISR   -0014   TF0     -008D   TR0     -008C   WAIT    -03DA
WCHR    -0441   WR      -0081   WSTR    -0433
