DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 1

0000                         1  ; STOPWATCH FORMAT HH2_HH1:MM2_MM1:SS2_SS1
0000                         2  
008C                         3  TR0 BIT TCON.4
008D                         4  TF0 BIT TCON.5
008E                         5  TR1 BIT	TCON.6
008F                         6  TF1 BIT TCON.7
0000                         7  ;-------------
0093                         8  R BIT P1.3
0090                         9  G BIT P1.0
0000                        10  ;-------------
0080                        11  LDATA EQU P0
0000                        12  ;------------
0082                        13  EN EQU P0.2
0080                        14  RS EQU P0.0
0081                        15  WR EQU P0.1
0000                        16  ;------------
0030                        17  SS1 EQU 30H
0031                        18  SS2	EQU 31H
0032                        19  MM1 EQU	32H
0033                        20  MM2 EQU 33H
0034                        21  HH1	EQU	34H
0035                        22  HH2	EQU	35H
0000                        23  ;------------------
0000                        24  		ORG 00H 
0000  02 03 00              25  	LJMP INIT_INTER
0003                        26  
0003                        27  		ORG 003H ; EX0 INT VECTOR ADDRESS
0003  02 00 16              28  	LJMP EX0ISR
0006                        29  
000B                        30  		ORG 00BH 
000B  02 00 27              31  	LJMP T0ISR
000E                        32  
0013                        33  		ORG 013H ; EX1 INT VECTOR ADDRESS
0013  02 00 1D              34  	LJMP EX1ISR
0016                        35  
0016                        36  ;--------INTERRUPT ROUTINES---
0016                        37  EX0ISR:				
0016                        38  ; USER ENTERS NEW TIME
0016  12 04 52              39  	LCALL PROMPT
0019  12 04 A9              40  	LCALL KEYPAD
001C  32                    41  	RETI
001D                        42  EX1ISR:
001D  12 04 3B              43  	LCALL RESTART_LCD
0020  12 04 2B              44  	LCALL G_LED			; FLASH G LED 3 TIMES
0023  02 03 0D              45  	LJMP INIT_LCD			; NOW START COUNTING
0026  32                    46  	RETI
0027                        47  T0ISR:
0027  12 03 76              48  	LCALL IntDELAY
002A  32                    49  	RETI
002B                        50  
002B                        51  
002B                        52  ;------------------------------
0300                        53  		ORG 300H
0300                        54  INIT_INTER:
0300  7E 64                 55  	MOV R6,#100
0302  75 8C B7              56  	MOV TH0,#0B7H
0305  75 8A EE              57  	MOV TL0,#0EEH
0308  D2 8C                 58  	SETB TR0
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 2

030A  75 A8 87              59  	MOV IE,#10000111B
030D                        60  
030D                        61  INIT_LCD:	
030D  75 89 01              62  	MOV TMOD,#000000001B
0310                        63  	
0310  75 30 00              64  	MOV SS1,#0    ; SS
0313  75 31 00              65  	MOV SS2,#0    ; SS
0316  75 32 00              66  	MOV MM1,#0    ; MM
0319  75 33 00              67  	MOV MM2,#0    ; MM
031C  75 34 00              68  	MOV HH1,#0    ; HH
031F  75 35 00              69  	MOV HH2,#0    ; HH
0322                        70  
0322                        71  AGAIN:
0322                        72  	;--------------SEND HH---------
0322  71 D9                 73  	ACALL LCD
0324  E5 35                 74  	MOV A,HH2 ; MOVE THE HH SECOND
0326  24 30                 75  	ADD A,#30H	;HEXIFY
0328  91 7B                 76  	ACALL WCHR 
032A  91 98                 77  	ACALL LDELAY ; 4.1 msec required for this command
032C                        78  	;---HH1
032C  E5 34                 79  	MOV A,HH1 ; MOVE THE HH FIRST
032E  24 30                 80  	ADD A,#30H
0330  91 7B                 81  	ACALL WCHR 
0332  91 98                 82  	ACALL LDELAY ; 4.1 msec required for this command
0334                        83  	
0334  74 3A                 84  	MOV A,#':' ; PUT A COLOR 
0336  91 7B                 85  	ACALL WCHR 
0338  91 98                 86  	ACALL LDELAY ; 4.1 msec required for this command
033A                        87  	;-------------- NOW SEND MM---------------
033A  E5 33                 88  	MOV A,MM2 ; MOVE THE MM SECOND
033C  24 30                 89  	ADD A,#30H
033E  91 7B                 90  	ACALL WCHR 
0340  91 98                 91  	ACALL LDELAY ; 4.1 msec required for this command
0342                        92  	
0342  E5 32                 93  	MOV A,MM1 ; MOVE THE MM SECOND
0344  24 30                 94  	ADD A,#30H
0346  91 7B                 95  	ACALL WCHR 
0348  91 98                 96  	ACALL LDELAY ; 4.1 msec required for this command
034A                        97  	
034A  74 3A                 98  	MOV A,#':' ; MOVE THE : 
034C  91 7B                 99  	ACALL WCHR 
034E  91 98                100  	ACALL LDELAY ; 4.1 msec required for this command
0350                       101  	;------------------ NOW SEND SS --------------------------------
0350                       102  	
0350  E5 31                103  	MOV A,SS2 ; MOVE THE SS FIRST
0352  24 30                104  	ADD A,#30H
0354  91 7B                105  	ACALL WCHR 
0356  91 98                106  	ACALL LDELAY ; 4.1 msec required for this command
0358                       107  	
0358  E5 30                108  	MOV A,SS1 ; MOVE THE SS FIRST
035A  24 30                109  	ADD A,#30H
035C  91 7B                110  	ACALL WCHR 
035E  91 98                111  	ACALL LDELAY ; 4.1 msec required for this command
0360                       112  	
0360                       113  	;------ RESUME
0360                       114  
0360  02 03 22             115  	LJMP AGAIN
0363                       116  
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 3

0363                       117  RESETT:
0363  75 34 00             118  	MOV HH1,#0
0366  75 35 00             119  	MOV HH2,#0
0369  75 32 00             120  	MOV MM1,#0
036C  75 33 00             121  	MOV MM2,#0
036F  75 30 00             122  	MOV SS1,#0
0372  75 31 00             123  	MOV SS2,#0
0375  22                   124  	RET
0376                       125  
0376                       126  	
0376                       127  ;---START OF SUB PROCESSES
0376                       128  IntDELAY:
0376  DE 60                129  	DJNZ R6,OUTT
0378                       130  
0378  A2 93                131  	MOV C,R
037A  B3                   132  	CPL C
037B  92 93                133  	MOV R,C
037D                       134  
037D  7E 64                135  	MOV R6,#100
037F                       136  	
037F                       137  		
037F                       138  ;-------------- HANDLE THE HH2HH1:MM2MM1:SS2SS1
037F                       139  	
037F  E5 30                140  	MOV A,SS1
0381  B4 09 33             141  	CJNE A,#9,INC_SS1
0384  75 30 00             142  	MOV SS1,#0			;MAKE ZER0
0387                       143  	
0387  E5 31                144  	MOV A,SS2
0389  B4 05 30             145  	CJNE A,#5,INC_SS2
038C  75 31 00             146  	MOV SS2,#0			;MAKE ZERO
038F                       147  	
038F  E5 32                148  	MOV A,MM1
0391  B4 09 2D             149  	CJNE A,#9,INC_MM1
0394  75 32 00             150  	MOV MM1,#0			;MAKE ZERO
0397                       151  	
0397  E5 33                152  	MOV A,MM2
0399  B4 05 2A             153  	CJNE A,#5,INC_MM2
039C  75 33 00             154  	MOV MM2,#0
039F                       155  	
039F  E5 34                156  	MOV A,HH1
03A1  B4 03 02             157  	CJNE A,#3,IsH1equal9
03A4  80 06                158  	SJMP IsH2equal2
03A6                       159  	
03A6                       160  IsH1equal9:
03A6  B4 09 22             161  	CJNE A,#9,INC_HH1
03A9  75 34 00             162  	MOV HH1,#0
03AC                       163  IsH2equal2:
03AC  E5 35                164  	MOV A,HH2
03AE  B4 02 1F             165  	CJNE A,#2,INC_HH2
03B1                       166  
03B1  12 03 63             167  	LCALL RESETT
03B4  02 03 D8             168  	LJMP OUTT	
03B7                       169  
03B7                       170  INC_SS1:
03B7  05 30                171  	INC SS1
03B9  02 03 D8             172  	LJMP OUTT
03BC                       173  INC_SS2:
03BC  05 31                174  	INC SS2
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 4

03BE  02 03 D8             175  	LJMP OUTT
03C1                       176  INC_MM1:
03C1  05 32                177  	INC MM1
03C3  02 03 D8             178  	LJMP OUTT
03C6                       179  INC_MM2:
03C6  05 33                180  	INC MM2
03C8  02 03 D8             181  	LJMP OUTT
03CB                       182  INC_HH1:
03CB  05 34                183  	INC HH1
03CD  02 03 D8             184  	LJMP OUTT
03D0                       185  INC_HH2:
03D0  05 35                186  	INC HH2
03D2                       187  
03D2  75 8C B7             188  	MOV TH0,#0B7H
03D5  75 8A EE             189  	MOV TL0,#0EEH
03D8                       190  OUTT:
03D8  22                   191  	RET	
03D9                       192  
03D9                       193  ;------------LCD
03D9                       194  START:
03D9                       195  LCD:		
03D9  71 E5                196  	ACALL INLCD ; Initialize LCD
03DB  74 08                197  	MOV A,#1000B ; Move cursor to 1st line – send high nibble
03DD  91 68                198  	ACALL CMD
03DF  74 00                199  	MOV A,#0000B ; send low nibble
03E1  91 68                200  	ACALL CMD
03E3  91 98                201  	ACALL LDELAY ; 4.1 msec required for this command
03E5                       202  
03E5                       203  ;-- LCD Initialization Procedure starts here -----
03E5                       204  INLCD:
03E5  7F 14                205  	MOV R7,#20
03E7                       206  WAIT:
03E7  91 98                207  	ACALL LDELAY ; Step 1
03E9  DF FC                208  	DJNZ R7,WAIT
03EB  75 80 07             209  	MOV P0,#00000111B ; Initialise 3 control signals=1
03EE                       210  	
03EE  74 03                211  	MOV A,#0011B ; Step 2
03F0  91 68                212  	ACALL CMD
03F2  91 98                213  	ACALL LDELAY ; Step 3
03F4  74 03                214  	MOV A,#0011B ; Step 4
03F6  91 68                215  	ACALL CMD
03F8  74 03                216  	MOV A,#0011B ; Step 5
03FA  91 68                217  	ACALL CMD
03FC  74 02                218  	MOV A,#0010B ; Step 6
03FE  91 68                219  	ACALL CMD
0400  74 02                220  	MOV A,#0010B ; Step 7 – send high nibble <FUNCTION SET?>
0402  91 68                221  	ACALL CMD
0404  74 08                222  	MOV A,#1000B ; send low nibble
0406  91 68                223  	ACALL CMD
0408  74 00                224  	MOV A,#0000B ; Step 8 – Turn off display – send high nibble
040A  91 68                225  	ACALL CMD
040C  74 08                226  	MOV A,#1000B ; send low nibble
040E  91 68                227  	ACALL CMD
0410  74 00                228  	MOV A,#0 ; Step 9 - Clear Display – send high nibble
0412  91 68                229  	ACALL CMD
0414  74 01                230  	MOV A,#0001B ; send low nibble
0416  91 68                231  	ACALL CMD
0418  91 98                232  	ACALL LDELAY ; 4.1 msec required for this command
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 5

041A  74 00                233  	MOV A,#0000B ; Step 10 - Set cursor Move RIGHT - send high nibble
041C  91 68                234  	ACALL CMD
041E  74 06                235  	MOV A,#0110B ; send low nibble
0420  91 68                236  	ACALL CMD
0422  74 00                237  	MOV A,#0000B ; Step 11 – send high nibble
0424  91 68                238  	ACALL CMD ; Turn ON Display, Cursor ON, Blink Cursor
0426  74 0F                239  	MOV A,#1111B ; send low nibble
0428  91 68                240  	ACALL CMD
042A  22                   241  	RET
042B                       242  ;--- End of LCD initialization -----
042B                       243  ;----Routines:
042B                       244  G_LED:
042B  79 03                245  	MOV R1,#3
042D                       246  MORE:	
042D  A2 90                247  	MOV C,G
042F  B3                   248  	CPL C
0430  92 90                249  	MOV G,C
0432  78 32                250  	MOV R0,#50	
0434                       251  GREEN:
0434  D8 FE                252  	DJNZ R0,GREEN	; HOLD LIGHT
0436  D9 F5                253  	DJNZ R1,MORE	; FLASH AGAIN
0438  D2 90                254  	SETB G			; TURN OFF LED
043A  22                   255  	RET
043B                       256  RESTART_LCD:
043B  75 35 00             257  	MOV HH2,#0	; RESET MEM LOCATIONS
043E  75 34 00             258  	MOV HH1,#0
0441  75 33 00             259  	MOV MM2,#0
0444  75 32 00             260  	MOV MM1,#0
0447  75 31 00             261  	MOV SS2,#0
044A  75 30 00             262  	MOV SS1,#0
044D                       263  				
044D  74 01                264  	MOV A,#1	; RESET DISPLAY
044F  02 04 68             265  	LJMP CMD
0452                       266  
0452                       267  PROMPT:		
0452                       268  	;PROMPT USER TO ENTER TIME		
0452  91 64                269  	ACALL LINE2		; GO TO LINE 2
0454  91 98                270  	ACALL LDELAY
0456  90 05 34             271  	MOV DPTR,#PROMPT_MSG ; POINT TO MSG
0459  91 6D                272  	ACALL WSTR				; WRITE STRING TO LCD
045B  91 98                273  	ACALL LDELAY
045D  91 60                274  	ACALL GET_INPUT			; get input from keyboard
045F  22                   275  	RET
0460                       276  GET_INPUT:
0460                       277  	; CODE
0460                       278  
0460                       279  ;---- Subroutines to write commands in A to the LCD -------
0460                       280  LINE1:
0460  74 00                281  	MOV A,#0
0462  80 04                282  	SJMP CMD
0464                       283  LINE2:
0464  74 C0                284  	MOV A,#11000000B	; 40 HEX = LINE 2
0466  80 00                285  	SJMP CMD
0468                       286  CMD:
0468  C2 80                287  	CLR RS 		; RS = 0 command write
046A  91 87                288  	ACALL COMMON
046C  22                   289  	RET
046D                       290  ;---- Subroutine to write A STRING character by character -------
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 6

046D                       291  WSTR:
046D  C0 E0                292  	PUSH ACC 
046F                       293  CONT1: 
046F  E4                   294  	CLR A
0470  93                   295  	MOVC A,@A+DPTR
0471  60 05                296  	JZ EXIT1
0473  91 7B                297  	ACALL WCHR
0475  A3                   298  	INC DPTR
0476  81 6F                299  	AJMP CONT1
0478                       300  EXIT1:
0478  D0 E0                301  	POP ACC
047A  22                   302  	RET
047B                       303  	;---- Subroutine to write character in A to the LCD -------
047B                       304  WCHR:
047B  D2 80                305  	SETB RS ; RS = 1 data write
047D  F5 F0                306  	MOV B,A
047F  C4                   307  	SWAP A ; Move higher nibble to lower nibble
0480  91 87                308  	ACALL COMMON ; write operation
0482  E5 F0                309  	MOV A,B
0484  91 87                310  	ACALL COMMON
0486  22                   311  	RET
0487                       312  ;----- Common operation for CHAR write and COMMAND write
0487                       313  COMMON:
0487  C2 81                314  	CLR WR
0489  C4                   315  	SWAP A ; Move Lower nibble to higher nibble
048A  54 F0                316  	ANL A,#11110000B
048C  53 80 07             317  	ANL P0,#00000111B
048F  42 80                318  	ORL P0,A
0491  D2 82                319  	SETB EN
0493  C2 82                320  	CLR EN
0495  91 98                321  	ACALL LDELAY
0497  22                   322  	RET
0498                       323  ;---- Subroutine to write A STRING character by character -------
0498                       324  
0498                       325  ;------------ ˜ 5.4 msec DELAY -------------------------------------------
0498                       326  LDELAY:
0498  C0 00                327  	PUSH 0
049A  C0 01                328  	PUSH 1 ; save register1.
049C  79 14                329  	MOV R1,#20
049E                       330  CON4: 
049E  78 FA                331  	MOV R0,#250
04A0  D8 FE                332  	DJNZ R0,$
04A2  D9 FA                333  	DJNZ R1,CON4
04A4  D0 01                334  	POP 1
04A6  D0 00                335  	POP 0
04A8  22                   336  	RET
04A9                       337  ;------------KEYPAD
04A9                       338  KEYPAD:
04A9  75 A0 F0             339  	MOV P2,#11110000B			;make bits P2.4-P2.7 input (columns)
04AC                       340  K1:
04AC  75 A0 F0             341  	MOV P2,#11110000B 
04AF  E5 A0                342  	MOV A,P2
04B1  54 F0                343  	ANL A,#11110000B 
04B3  B4 F0 F6             344  	CJNE A,#11110000B,K1
04B6                       345  K2: 
04B6  B1 11                346  	ACALL DELAY 
04B8  E5 A0                347  	MOV A,P2
04BA  54 F0                348  	ANL A,#11110000B
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 7

04BC  B4 F0 00             349  	CJNE A,#11110000B,OVER SJMP K2
04BF                       350  OVER:
04BF  B1 11                351  	ACALL DELAY
04C1  E5 A0                352  	MOV A,P2
04C3  54 F0                353  	ANL A,#11110000B
04C5  B4 F0 00             354  	CJNE A,#11110000B,OVER1 SJMP K2
04C8                       355  OVER1:
04C8  75 A0 FE             356  	MOV P2,#11111110B
04CB  E5 A0                357  	MOV A,P2
04CD  54 F0                358  	ANL A,#11110000B
04CF  B4 F0 21             359  	CJNE A,#11110000B,ROW_0
04D2  75 A0 FD             360  	MOV P2,#11111101B
04D5  E5 A0                361  	MOV A,P2
04D7  54 F0                362  	ANL A,#11110000B
04D9  B4 F0 1C             363  	CJNE A,#11110000B,ROW_1
04DC  75 A0 FB             364  	MOV P2,#11111011B
04DF  E5 A0                365  	MOV A,P2
04E1  54 F0                366  	ANL A,#11110000B
04E3  B4 F0 17             367  	CJNE A,#11110000B,ROW_2
04E6  75 A0 F7             368  	MOV P2,#11110111B
04E9  E5 A0                369  	MOV A,P2
04EB  54 F0                370  	ANL A,#11110000B
04ED  B4 F0 12             371  	CJNE A,#11110000B,ROW_3
04F0  02 04 B6             372  	LJMP K2
04F3                       373  ROW_0: 
04F3  90 05 24             374  	MOV DPTR,#KCODE0 
04F6  80 0D                375  	SJMP FIND
04F8                       376  ROW_1: 
04F8  90 05 28             377  	MOV DPTR,#KCODE1 
04FB  80 08                378  	SJMP FIND
04FD                       379  ROW_2: 
04FD  90 05 2C             380  	MOV DPTR,#KCODE2 
0500  80 03                381  	SJMP FIND
0502                       382  ROW_3: 
0502  90 05 30             383  	MOV DPTR,#KCODE3 
0505                       384  FIND:
0505  C4                   385  	SWAP A
0506                       386  FIND1:
0506  13                   387  	RRC A
0507  50 03                388  	JNC MATCH 
0509  A3                   389  	INC DPTR 
050A  80 FA                390  	SJMP FIND1
050C                       391  	
050C                       392  MATCH: 
050C  E4                   393  	CLR A
050D  93                   394  	MOVC A,@A+DPTR
050E  94 30                395  	SUBB A,#30H
0510  22                   396  	RET
0511                       397  
0511                       398  	; 30 msec delay 
0511                       399  DELAY:
0511  75 89 01             400  	MOV TMOD,#00000001B 
0514  75 8B CA             401  	MOV TL1,#0CAH
0517  75 8D 27             402  	MOV TH1,#27H
051A  D2 8E                403  	SETB TR1
051C                       404  BACK: 
051C  30 8F FD             405  	JNB TF1,BACK 
051F  C2 8E                406  	CLR TR1
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 8

0521  C2 8F                407  	CLR TF1
0523  22                   408  	RET
0524                       409  
0524  31 32 33 30          410  KCODE0: DB '1','2','3','0'
0528  34 35 36 30          411  KCODE1: DB '4','5','6','0'
052C  37 38 39 30          412  KCODE2: DB '7','8','9','0'
0530  30 30 30 30          413  KCODE3: DB '0','0','0','0'
0534                       414  
0534  50 6C 65 61 73 65 +  415  PROMPT_MSG: STRZ "Please enter new time"
054A                       416  END
DUNFIELD 8051 ASSEMBLER: CODE                                         PAGE: 9

SYMBOL TABLE:

AGAIN   -0322   BACK    -051C   CMD     -0468   COMMON  -0487   CON4    -049E
CONT1   -046F   DELAY   -0511   EN      -0082   END     -054A   EX0ISR  -0016
EX1ISR  -001D   EXIT1   -0478   FIND    -0505   FIND1   -0506   G       -0090
GET_INPUT               -0460   GREEN   -0434   G_LED   -042B   HH1     -0034
HH2     -0035   INC_HH1 -03CB   INC_HH2 -03D0   INC_MM1 -03C1   INC_MM2 -03C6
INC_SS1 -03B7   INC_SS2 -03BC   INIT_INTER              -0300   INIT_LCD-030D
INLCD   -03E5   INTDELAY-0376   ISH1EQUAL9              -03A6   ISH2EQUAL2              -03AC
K1      -04AC   K2      -04B6   KCODE0  -0524   KCODE1  -0528   KCODE2  -052C
KCODE3  -0530   KEYPAD  -04A9   LCD     -03D9   LDATA   -0080   LDELAY  -0498
LINE1   -0460   LINE2   -0464   MATCH   -050C   MM1     -0032   MM2     -0033
MORE    -042D   OUTT    -03D8   OVER    -04BF   OVER1   -04C8   PROMPT  -0452
PROMPT_MSG              -0534   R       -0093   RESETT  -0363   RESTART_LCD             -043B
ROW_0   -04F3   ROW_1   -04F8   ROW_2   -04FD   ROW_3   -0502   RS      -0080
SS1     -0030   SS2     -0031   START   -03D9   T0ISR   -0027   TF0     -008D
TF1     -008F   TR0     -008C   TR1     -008E   WAIT    -03E7   WCHR    -047B
WR      -0081   WSTR    -046D
